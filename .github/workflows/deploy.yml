name: deploy-book
on:
  push:
    branches: [main, master]

permissions:
  pages: write
  id-token: write
  contents: read

jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install "jupyter-book==2.0.2"

      - name: Prepare working tree
        run: |
          rm -rf _jb_src
          rsync -a --exclude '_build' --exclude '.git' --exclude '_jb_src' ./ _jb_src/

      - name: Sanity check config
        run: |
          test -f _jb_src/_config.yml || (echo "_config.yml missing in _jb_src" && exit 1)
          test -f _jb_src/_toc.yml || (echo "_toc.yml missing in _jb_src" && exit 1)

      - name: Build Jupyter Book (force html)
        run: |
          set -e
          jupyter-book build _jb_src --builder html 2>&1 | tee build.log

      - name: Ensure build output exists (html or dirhtml)
        run: |
          if [ -d "_jb_src/_build/html" ]; then
            echo "Found _build/html"
            echo "_jb_src/_build/html" > build_path.txt
          elif [ -d "_jb_src/_build/dirhtml" ]; then
            echo "Found _build/dirhtml"
            echo "_jb_src/_build/dirhtml" > build_path.txt
          else
            echo "Build failed: no _build/html or _build/dirhtml produced."
            sed -n '1,300p' build.log || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: $(cat build_path.txt)

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
