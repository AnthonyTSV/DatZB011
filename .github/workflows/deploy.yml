name: deploy-book
on:
  push:
    branches: [main, master]

permissions:
  pages: write
  id-token: write
  contents: read

jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -U 'sphinx>=5.0' 'jupyter-book==0.13.*' myst-parser lxml[html_clean]
          jupyter-book --version

      # Make a temp working copy so originals stay untouched
      - name: Prepare working tree
        run: |
          rm -rf _jb_src
          rsync -a --exclude '_build' --exclude '.git' --exclude '_jb_src' ./ _jb_src/

      - name: List files in _jb_src
        run: ls -R _jb_src

      # Convert >[!NOTE] to ```{note} ... ``` (skip non-file md entries)
      - name: Convert GitHub alert blocks to MyST
        run: |
          python - <<'PY'
          from pathlib import Path
          import re, sys
          ROOT = Path('_jb_src')
          ALERT_START = re.compile(r'^\s*>\s*\[!(\w+)\]\s*(.*)$')
          QUOTE_LINE  = re.compile(r'^\s*>\s?(.*)$')
          MAP = {"NOTE":"note","TIP":"tip","IMPORTANT":"important","WARNING":"warning","CAUTION":"warning"}
          def convert_text(t:str)->str:
              out, lines, i, n = [], t.splitlines(), 0, 0
              n = len(lines)
              while i < n:
                  m = ALERT_START.match(lines[i])
                  if not m:
                      out.append(lines[i]); i+=1; continue
                  kind = MAP.get(m.group(1).upper(), "note")
                  body = [m.group(2).rstrip()] if m.group(2).strip() else []
                  i += 1
                  while i < n and (q:=QUOTE_LINE.match(lines[i])):
                      body.append(q.group(1).rstrip()); i += 1
                  while body and body[0]=="": body.pop(0)
                  while body and body[-1]=="" : body.pop()
                  out.append(f"```{{{kind}}}")
                  out.extend(body or [""])
                  out.append("```")
              return "\n".join(out)
          for md in ROOT.rglob("*.md"):
              if not md.is_file():
                  print("Skipping non-file:", md)
                  continue
              try:
                  src = md.read_text(encoding="utf-8")
              except Exception as e:
                  print(f"Failed to read {md}: {e}")
                  raise
              md.write_text(convert_text(src), encoding="utf-8")
          PY

      - name: Check _jb_src content
        run: |
          echo "Files at top of _jb_src:"
          ls -la _jb_src | sed -n '1,200p'
          test -f _jb_src/_config.yml || (echo "_config.yml missing in _jb_src" && exit 1)
          test -f _jb_src/_toc.yml || (echo "_toc.yml missing in _jb_src" && exit 1)

      - name: Detect problematic .md directories
        run: |
          python - <<'PY'
          from pathlib import Path
          bad=[]
          for p in Path('_jb_src').rglob('*'):
            if p.is_dir() and p.name.lower().endswith('.md'):
              bad.append(str(p))
            if p.is_symlink():
              try:
                if Path(p.resolve()).is_dir():
                  bad.append(str(p)+" -> symlink to dir")
              except Exception:
                bad.append(str(p)+" -> symlink unresolved")
          if bad:
            print("Found problematic entries that may cause EISDIR:")
            print('\n'.join(bad))
            raise SystemExit(2)
          print("No obvious .md-as-directory or symlink issues found.")
          PY

      - name: Build Jupyter Book
        run: |
          set -e
          jupyter-book build _jb_src -v
          if [ ! -d "_jb_src/_build/html" ]; then
            echo "Build failed: _jb_src/_build/html does not exist."
            ls -la _jb_src/_build || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_jb_src/_build/html"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
