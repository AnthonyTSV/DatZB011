name: deploy-book
on:
  push:
    branches: [main, master]

permissions:
  pages: write
  id-token: write
  contents: read

jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -U jupyter-book

      # Make a temp working copy so originals stay untouched
      - name: Prepare working tree
        run: |
          rsync -a --exclude '_build' ./ ./_jb_src/

      # Convert >[!NOTE] to ```{note} ... ```
      - name: Convert GitHub alert blocks to MyST
        run: |
          python - <<'PY'
          from pathlib import Path
          import re, sys
          ROOT = Path('_jb_src')
          ALERT_START = re.compile(r'^\s*>\s*\[\!(\w+)\]\s*(.*)$')
          QUOTE_LINE  = re.compile(r'^\s*>\s?(.*)$')
          MAP = {"NOTE":"note","TIP":"tip","IMPORTANT":"important","WARNING":"warning","CAUTION":"warning"}
          def convert_text(t:str)->str:
              out, lines, i, n = [], t.splitlines(), 0, 0
              n = len(lines)
              while i < n:
                  m = ALERT_START.match(lines[i])
                  if not m:
                      out.append(lines[i]); i+=1; continue
                  kind = MAP.get(m.group(1).upper(), "note")
                  body = [m.group(2).rstrip()] if m.group(2).strip() else []
                  i += 1
                  while i < n and (q:=QUOTE_LINE.match(lines[i])):
                      body.append(q.group(1).rstrip()); i += 1
                  while body and body[0]=="": body.pop(0)
                  while body and body[-1]=="" : body.pop()
                  out.append(f"```{{{kind}}}")
                  out.extend(body or [""])
                  out.append("```")
              return "\n".join(out)
          for md in ROOT.rglob("*.md"):
              md.write_text(convert_text(md.read_text(encoding="utf-8")), encoding="utf-8")
          PY

      - name: Build Jupyter Book
        run: jupyter-book build _jb_src

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_jb_src/_build/html"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
